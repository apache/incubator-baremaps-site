(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[777],{2159:function(e,s,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/documentation/developer-manual/ip-to-location",function(){return n(7812)}])},7812:function(e,s,n){"use strict";n.r(s);var t=n(5893),o=n(4319),l=n(1151);function a(e){let s=Object.assign({h1:"h1",p:"p",ul:"ul",li:"li",a:"a",em:"em",h2:"h2",pre:"pre",code:"code",span:"span",ol:"ol"},(0,l.ah)(),e.components);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{children:"IP to location"}),"\n",(0,t.jsx)(s.p,{children:"Using data publicly available from the 5 Regional Internet Registries (RIRs)\nwe are able to generate a stream of objects detailing Internet resource allocations. We call these NIC Objects\n(Network Information Centre Objects)."}),"\n",(0,t.jsx)(s.p,{children:"Here is the list of the 5 RIRs."}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://www.arin.net/",children:"ARIN"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://www.lacnic.net/",children:"LACNIC"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://afrinic.net/",children:"AFRINIC"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://www.ripe.net/",children:"RIPE NCC"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://www.apnic.net/",children:"APNIC"})}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"Using the list of NIC objects, we extract those that concern IPv4 address ranges (INETNUM)\n, then using the Baremaps Geocoder API, we iterate through the extracted NIC objects to geo-locate each one of them."}),"\n",(0,t.jsx)(s.p,{children:"The resulting geo-localised IPv4 address ranges are stored in a SQLite database which can be easily queried to geo-locate a specific IP."}),"\n",(0,t.jsx)(s.p,{children:"A NIC object contains a list of attributes but these attributes are not consistent between each NIC object.\nWe try to use these 4 attributes to query the Geocoder service :"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"address"})," contains the address of the NIC Object"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"descr"})," sometimes contains the address of the NIC Object"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"country"})," contains the country code in ISO format (ISO 3166)"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.em,{children:"geoloc"})," contains the latitude and longitude which can be used directly"]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"Some NIC Objects contain a reference to an organisation, and the organisation's NIC Object itself contains the\ngeo-localisation information. However, we don't make use of that for now."}),"\n",(0,t.jsx)(s.p,{children:"The structure of the RIPE database should be applicable to all the RIRs."}),"\n",(0,t.jsx)(s.h2,{id:"generating-the-ip-to-location-database",children:"Generating the IP to location database"}),"\n",(0,t.jsxs)(s.p,{children:["A workflow is a directed acyclic graph of steps executed by Baremaps. To download and import the sample OSM data in Postgres, execute the following ",(0,t.jsx)(s.a,{href:"https://raw.githubusercontent.com/apache/incubator-baremaps/main/additional-examples/ip-to-location/workflow.js",children:"workflow"}),"."]}),"\n",(0,t.jsx)(s.pre,{"data-language":"bash","data-theme":"default",children:(0,t.jsx)(s.code,{"data-language":"bash","data-theme":"default",children:(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"baremaps "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"workflow"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"execute"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"--file"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string)"},children:"examples/ip-to-location/workflow.js"})]})})}),"\n",(0,t.jsx)(s.p,{children:"Depending on the size of the OpenStreetMap file, the execution of this command may take some time.\nEventually, the output produced by the command should look as follows."}),"\n",(0,t.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"text","data-theme":"default",children:[(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[INFO ] 2022-12-08 12:56:05.417 [main] Execute - Executing the workflow examples/ip-to-location/workflow.js"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[INFO ] 2022-12-08 12:56:06.031 [pool-2-thread-1] DownloadUrl - Downloading https://ftp.ripe.net/ripe/dbase/ripe.db.gz to downloads/ripe.db.gz"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[INFO ] 2022-12-08 12:56:06.031 [pool-2-thread-2] DownloadUrl - Downloading https://download.geonames.org/export/dump/allCountries.zip to downloads/geonames-allcountries.zip"})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"..."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"..."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"..."})}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"[INFO ] 2022-07-26 09:48:21.368 [main] Workflow - Finished executing workflow examples/ip-to-location/workflow.js"})})]})}),"\n",(0,t.jsx)(s.pre,{"data-language":"text","data-theme":"default",children:(0,t.jsx)(s.code,{"data-language":"text","data-theme":"default",children:(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"iploc serve --database iploc.db --port 3000"})})})}),"\n",(0,t.jsx)(s.h2,{id:"code-usage",children:"Code usage"}),"\n",(0,t.jsx)(s.p,{children:"In order to generate the SQLite database that contains the geo-localised IP address ranges you must follow a few steps."}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsx)(s.li,{children:"First you need to load/build a Geocoder which will be used to query the addresses contained in the NIC objects."}),"\n"]}),"\n",(0,t.jsx)(s.pre,{"data-language":"java","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"java","data-theme":"default",children:[(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Geocoder"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" geocoder "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"GeonamesGeocoder(indexPath"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" dataUri)"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"geocoder"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"build"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]})]})}),"\n",(0,t.jsxs)(s.ol,{start:"2",children:["\n",(0,t.jsx)(s.li,{children:"Then you need to generate a Stream of NIC Objects. You can use the Nic Fetcher to automatically download all of the NIC Objects from the 5 RIRs."}),"\n"]}),"\n",(0,t.jsx)(s.pre,{"data-language":"java","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"java","data-theme":"default",children:[(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Stream"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"<"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Path"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"> nicPathsStream "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"NicFetcher()"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"fetch"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"Stream"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"<"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"NicObject"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"> nicObjectStream "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"nicPathsStream"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"flatMap"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(nicPath "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"->"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"try"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" {"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"NicParser"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"parse"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"BufferedInputStream("}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"Files"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"newInputStream(nicPath))"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:");"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        } "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"catch"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ("}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"IOException"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" e) {"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"            "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"e"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"printStackTrace"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        }"})}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"        "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"return"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"Stream"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"empty"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"();"})]}),"\n",(0,t.jsx)(s.span,{className:"line",children:(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"    });"})})]})}),"\n",(0,t.jsxs)(s.ol,{start:"3",children:["\n",(0,t.jsx)(s.li,{children:"You need to create the IpLoc service, giving the target SQLite database url and the geocoder in the second parameter"}),"\n"]}),"\n",(0,t.jsx)(s.pre,{"data-language":"java","data-theme":"default",children:(0,t.jsxs)(s.code,{"data-language":"java","data-theme":"default",children:[(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"SqliteUtils"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"executeResource"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"(databaseUrl"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-string-expression)"},children:'"iploc_init.sql"'}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"); "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-comment)"},children:"// Init the SQLite database"})]}),"\n",(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"IpLoc"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" ipLoc "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"="}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-keyword)"},children:"new"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:" "}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"IpLoc(databaseUrl"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:","}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:" geocoder)"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:";"})]})]})}),"\n",(0,t.jsxs)(s.ol,{start:"4",children:["\n",(0,t.jsx)(s.li,{children:"Finally insert the stream of NIC objects in the database with the IpLoc service"}),"\n"]}),"\n",(0,t.jsx)(s.pre,{"data-language":"java","data-theme":"default",children:(0,t.jsx)(s.code,{"data-language":"java","data-theme":"default",children:(0,t.jsxs)(s.span,{className:"line",children:[(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"ipLoc"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"insertNicObjects"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"("}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-constant)"},children:"nicObjects"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-punctuation)"},children:"."}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-token-function)"},children:"stream"}),(0,t.jsx)(s.span,{style:{color:"var(--shiki-color-text)"},children:"());"})]})})}),"\n",(0,t.jsx)(s.h2,{id:"notes",children:"Notes"}),"\n",(0,t.jsxs)(s.p,{children:["There are many improvements that need to be worked on to improve the Iploc module, refer to the Github issues with the\ntag ",(0,t.jsx)(s.em,{children:"iploc"})," if you want to contribute."]}),"\n",(0,t.jsx)(s.h2,{id:"references",children:"References"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://apps.db.ripe.net/docs/",children:"https://apps.db.ripe.net/docs/"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://www.iana.org/numbers",children:"https://www.iana.org/numbers"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"https://www.irr.net/docs/list.html",children:"https://www.irr.net/docs/list.html"})}),"\n"]})]})}n(5675),s.default=(0,o.j)({MDXContent:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:s}=Object.assign({},(0,l.ah)(),e.components);return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(a,{...e})}):a(e)},pageOpts:{filePath:"src/pages/documentation/developer-manual/ip-to-location.mdx",route:"/documentation/developer-manual/ip-to-location",frontMatter:{layout:"default",title:"IP to location"},headings:[{depth:1,value:"IP to location",id:"ip-to-location"},{depth:2,value:"Generating the IP to location database",id:"generating-the-ip-to-location-database"},{depth:2,value:"Code usage",id:"code-usage"},{depth:2,value:"Notes",id:"notes"},{depth:2,value:"References",id:"references"}],title:"IP to location"},pageNextRoute:"/documentation/developer-manual/ip-to-location"})}},function(e){e.O(0,[319,774,888,179],function(){return e(e.s=2159)}),_N_E=e.O()}]);